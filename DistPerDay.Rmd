---
title: "Data_Join"
date: "05/12/2021"
output: html_document
---

```{r}
library(tidyverse)
#library(ggthemes)
#library(ggmap)
library(move)
#library(moveVis)
library(directlabels)
library(lubridate)#is this part of tidy?
library(zoo)#ma
library(scales)
library(RColorBrewer)


CatDatAus <- move("PetCatsAus.csv") 
CatDatNZ <- move("PetCatsNZ.csv")  
CatDatUK <- move("PetCatsUK.csv") 
CatDatUS <- move("PetCatsUS.csv")  

RefAus <- read.csv("Pet Cats Australia-reference-data.csv")
RefUK <- read.csv("Pet Cats United Kingdom-reference-data.csv")
RefNZ <- read.csv("Pet Cats New Zealand-reference-data.csv")
RefUS <- read.csv("Pet Cats United States-reference-data.csv")


#join movement and reference data
CatDFAus<-(left_join(as.data.frame(CatDatAus), RefAus, by=c("trackId"="animal.id"))
           %>% mutate(Country = "Australia")
)

CatDFUK<-(left_join(as.data.frame(CatDatUK), RefUK, by=c("trackId"="animal.id"))
 %>% mutate(Country = "United Kingdom")
)
CatDFUS<-(left_join(as.data.frame(CatDatUS), RefUS, by=c("trackId"="animal.id"))
 %>% mutate(Country = "United States")
)
CatDFNZ<-(left_join(as.data.frame(CatDatNZ), RefNZ, by=c("trackId"="animal.id"))
 %>% mutate(Country = "New Zealand")
)

#union all data into one 
cats<-union_all(CatDFAus, CatDFNZ)
cats<-union_all(cats, CatDFUK)
cats<-union_all(cats, CatDFUS)


#distance per day per cat
dist <- (cats
         %>% arrange(Country, trackId, timestamp)
         %>% group_by(Country,trackId, day=floor_date(timestamp, "day"))
        %>% mutate(dist_btw = distHaversine(cbind(location.long, location.lat),cbind(lag(location.long),lag(location.lat))))

        %>% mutate(dist_btw = if_else(is.na(dist_btw),0,dist_btw))
        %>% group_by(Country, trackId, day)
        %>% mutate(dist_per_day = sum(dist_btw))
        #162 records with dist_per_day=0
        %>% filter(dist_per_day !=0 )
        %>% ungroup()
)
#max per day is ~45km, Bagheera (Aus) - possible?

country_dist <-(dist
                %>% dplyr::select(Country,day,dist_per_day)
                %>% group_by(Country,day)
                %>% mutate(mean_dist=mean(dist_per_day),
                           year =year(day),
                           day = as.Date(day,format="%Y-%m-%d"))
                %>% ungroup()
                %>% dplyr::select(-dist_per_day)
                %>% arrange(Country, day)
                %>% distinct()
                %>% group_by(Country)
                %>% mutate(MA_2=zoo::rollmean(mean_dist, k=2, fill=NA))
                %>% mutate(MA_3=zoo::rollmean(mean_dist, k=3, fill=NA))
                %>% mutate(MA_5=zoo::rollmean(mean_dist, k=5, fill=NA))
                %>% mutate(MA_10=zoo::rollmean(mean_dist, k=10, fill=NA))
                %>% mutate(MA_15=zoo::rollmean(mean_dist, k=15, fill=NA))
                %>% filter(year==2015)

  
)

#day/night distances
day_night <- (cats
         %>% arrange(Country, trackId, timestamp)
         #drop time
         %>% mutate(dy=floor_date(timestamp, "day"),
                    hr = hour(round_date(timestamp, "hour")),
                    diurnal = ifelse((hr < 6 | hr > 18), "Night", "Day"))
         %>% group_by(Country, trackId)
         #distance computed between each successive timestamp
         #each change from "Day" to "Night" will contain distance spillover
         %>% mutate(dist_btw = distHaversine(cbind(location.long, location.lat),cbind(lag(location.long),lag(location.lat))))
         # set first record for each cat to 0 distance
         %>% mutate(dist_btw = if_else(is.na(dist_btw),0,dist_btw))
         %>% ungroup() #do I need to ungroup?
         %>% group_by(Country, trackId, diurnal)
         %>% summarize(Total_diurnal=sum(dist_btw))

)

#number of days each cat is tracked
days_tracked<- (cats
         %>% arrange(Country, trackId, timestamp)
         #drop time
         %>% mutate(dy=floor_date(timestamp, "day"))
         %>% group_by(Country, trackId)
         #number of days each cat is tracked
         %>% summarize(days = n_distinct(dy), .groups="keep")
)

avg_day_night <- (left_join(day_night, days_tracked, by=c("Country"="Country", "trackId"="trackId"))
                  %>% mutate(avg = Total_diurnal/days)
                  %>% filter(avg < 5000) #look at outliers, decide on threshold
)
```

```{r}

(ggplot(avg_day_night, aes(x=diurnal,y=avg))
 + geom_boxplot()
 #+ geom_point(aes(colour=diurnal, alpha=0.3))
 #+ geom_smooth()
 )
```


```{r}


(ggplot(country_dist, aes(x=day, y=mean_dist))
    + geom_point(alpha=0.4,aes(colour=Country))
    + geom_line(aes(x=day,y=MA_5,colour=Country),lwd=0.8)
    + scale_y_log10(labels = trans_format("log10", math_format(10^.x)))
    + theme_bw()
    + theme(legend.position="none",
            panel.grid.minor.x=element_blank(),
            panel.grid.major.y=element_blank(),
            panel.grid.minor.y=element_blank())
    + geom_dl(aes(label=Country,colour=Country),method="smart.grid",size=5)
    + scale_x_date(labels=date_format("%b"), date_breaks = "1 month", expand=c(0.01,0.01))
    + xlab("")
    + ylab("Mean distance travelled (m)")
    + scale_colour_manual(values = brewer.pal(3,"Dark2"))
    + ggtitle("Distance travelled per day by pet cats (2015)")
)

ggsave("DistPerDay.png", width=6.5,height=4)



```

````{r}
#distance per day per cat
dist <- (cats
         %>% arrange(Country, trackId, timestamp)
         %>%group_by(Country,trackId,day=floor_date(timestamp, "day"))
        %>% mutate(dist_btw = distHaversine(cbind(location.long, location.lat),cbind(lag(location.long),lag(location.lat))))

        %>% mutate(dist_btw = if_else(is.na(dist_btw),0,dist_btw))
        %>% group_by(Country, trackId, day)
        %>% mutate(dist_per_day = sum(dist_btw))
        #162 records with dist_per_day=0
        %>% filter(dist_per_day !=0, dist_per_day < 20000 )
        %>% ungroup()
)
#max per day is ~45km, Bagheera (Aus) - possible?

country_dist <-(dist
                %>% dplyr::select(Country,day,dist_per_day)
                %>% group_by(Country,day)
                %>% mutate(mean_dist=mean(dist_per_day),
                           year =year(day),
                           day = as.Date(day,format="%Y-%m-%d"))
                %>% ungroup()
                %>% dplyr::select(-dist_per_day)
                %>% arrange(Country, day)
                %>% distinct()
                %>% group_by(Country)
                %>% mutate(MA_2=zoo::rollmean(mean_dist, k=2, fill=NA))
                %>% mutate(MA_3=zoo::rollmean(mean_dist, k=3, fill=NA))
                %>% mutate(MA_5=zoo::rollmean(mean_dist, k=5, fill=NA))
                %>% mutate(MA_10=zoo::rollmean(mean_dist, k=10, fill=NA))
                %>% mutate(MA_15=zoo::rollmean(mean_dist, k=15, fill=NA))
                %>% filter(year==2015)

  
)


```


```{r}

(ggplot(country_dist, aes(x=day, y=mean_dist, colour=Country))
    + geom_point(alpha=0.4,aes(colour=Country))
    + geom_smooth(span = 0.4, se = FALSE)
    #+ geom_line(aes(x=day,y=MA_5,colour=Country),lwd=0.8)
    + scale_y_log10(labels = trans_format("log10", math_format(10^.x)))
    + theme_bw()
    + theme(legend.position="none",
            panel.grid.minor.x=element_blank(),
            panel.grid.major.y=element_blank(),
            panel.grid.minor.y=element_blank())
    + geom_dl(aes(label=Country,colour=Country),method="smart.grid",size=5)
    + scale_x_date(labels=date_format("%b"), date_breaks = "1 month", expand=c(0.01,0.01))
    + xlab("")
    + ylab("Mean distance travelled (m)")
    + scale_colour_manual(values = brewer.pal(3,"Dark2"))
    + ggtitle("Distance travelled per day by pet cats (2015)")
)

ggsave("DistPerDay2.png", width=6.5,height=4)


```
### Data Viz Choices

1. Data Cleaning
  * Removed 162 records where the cat travelled 0 meters in a day. These occured when there was only 1 recorded measurement in a day.
  * Chose to keep extreme values. One cat from Australia covered ~45km in one day, feasible but unusual. Next highest ~35km/day and ~21km/day.
2. Data Plotting
   * log-transformed distance axis to account for more extreme values
   * 5-day moving average line to see patterns
2. Aesthetics
  * Colours - Dark2 from ColourBrewer, distinct
  * Direct labelling Countries
  * Include data with moving average line
  * transparency of data points to hightlight lines
  * Vertical gridlines to highlight the months
  * Compressed math format for long scale
  
### Questions 

* Are their cylces or patterns to the distance travelled? 
* Are their differences between countries?